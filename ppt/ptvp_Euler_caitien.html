<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PP Euler cải tiến</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
            /* Added for page transition */
            opacity: 1;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Added for page transition */
        body.page-fade-out {
            opacity: 0;
            transform: translateY(30px);
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            position: relative;
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background-color: var(--secondary-color);
        }

        .input-section {
            background-color: rgb(240, 245, 255);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 15px;
            flex: 1;
            /* Added to make groups share space */
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        button {
            background: linear-gradient(to right, #0D47A1, #0288D1, #4FC3F7);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 25px auto;
            transition: all 0.3s;
            width: 220px;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: linear-gradient(to right, rgba(0, 123, 255, 0.8), rgba(0, 196, 180, 0.2));
            transform: translateY(-2px);
        }

        /* ... các style khác giữ nguyên ... */

        .result-section {
            background-color: white;
            /* padding: 25px; <-- Chuyển sang .show */
            padding: 0 25px;
            /* Giữ padding ngang nếu muốn */
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            /* margin-top: 25px; <-- Chuyển sang .show */
            margin-top: 0;
            /* ---- Added/Modified for animation & no initial space ---- */
            opacity: 0;
            transform: translateY(30px);
            visibility: hidden;
            max-height: 0;
            /* Thu gọn chiều cao ban đầu */
            overflow: hidden;
            /* Ẩn nội dung khi thu gọn */
            transition: opacity 0.5s ease-out,
                transform 0.5s ease-out,
                max-height 0.5s ease-out,
                /* Thêm transition cho max-height */
                padding-top 0.5s ease-out,
                /* Thêm transition cho padding */
                padding-bottom 0.5s ease-out,
                margin-top 0.5s ease-out;
            /* Thêm transition cho margin */
            /* ------------------------------------------------------- */
        }

        .result-section.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
            max-height: 200vh;
            /* Đặt giá trị đủ lớn để chứa mọi nội dung có thể */
            padding: 25px;
            /* Khôi phục padding */
            margin-top: 25px;
            /* Khôi phục margin-top */
        }

        /* ... các style còn lại giữ nguyên ... */
        /* --------------------------- */

        .result-title {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        th,
        td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .math-formula {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .step {
            margin-bottom: 25px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .final-result {
            background-color: #d9f1fc;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid rgb(49, 112, 249);
            margin-top: 25px;
        }

        .error {
            color: var(--error-color);
            background-color: #fde8e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--error-color);
        }

        .success-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid rgb(49, 112, 249);
        }

        .success-box h3 {
            /* This was likely unused in original */
            color: var(--success-color);
            margin-top: 0;
        }

        .success-box2 {
            background-color: rgb(243, 253, 244);
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            height: 100px;
            /* Original fixed height */
            border-left: 4px solid var(--success-color);
        }

        .input-row {
            display: flex;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .input-row {
                flex-direction: column;
                gap: 0;
                /* Original was 15px, reverting */
            }

            .input-group {
                margin-bottom: 15px;
                /* Added back for spacing when stacked */
            }
        }

        .scrollable-table {
            max-height: 300px;
            overflow-y: auto;
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 15px 0;
        }

        .scrollable-table table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            /* Added */
        }

        .scrollable-table th {
            position: sticky;
            top: 0;
            background: #3498db;
            color: white;
            z-index: 10;
        }

        .scrollable-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .scrollable-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .toggle-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0;
            width: auto;
            transition: all 0.3s;
            flex-shrink: 0;
            /* Added */
        }

        .toggle-btn:hover {
            background-color: #5a6268;
        }

        .horizontal-scroll-container {
            overflow-x: auto;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .horizontal-table {
            width: auto;
            /* Original */
            min-width: 100%;
            /* Added */
            border-collapse: collapse;
            white-space: nowrap;
            margin: 0;
            /* Added */
        }

        .horizontal-table th,
        .horizontal-table td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 120px;
        }

        .horizontal-table th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1;
            /* Added */
        }

        .horizontal-table td {
            /* Added */
            background-color: white;
        }


        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            /* Original */
            z-index: 2;
            border-right: 2px solid #ccc;
            /* Added */
        }
    </style>
</head>

<body>
    <button onclick="goToHomeWithTransition()"
        style="width: 400px; height: 50px; text-align: center; background: linear-gradient(135deg, #00B4DB, #0083B0, #00FF7F);">Home</button>
    <h1>PP Euler cải tiến </h1>

    <div class="input-section">
        <div class="input-group">
            <label for="y_diff">Phương trình vi phân \( y' = f(x, y) \):</label>
            <input type="text" id="y_diff" placeholder="e.g., x + y" value="5*y + 2*e^x"> <small
                style="color: #7f8c8d; font-size: 0.9em;">Use JavaScript math syntax: e.g., x*y, x^2, log(x), sin(x),
                e^x</small>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="x0">Điểm ban đầu \( x_0 \):</label>
                <input type="number" id="x0" step="any" value="0.01">
            </div>
            <div class="input-group">
                <label for="y0">Giá trị ban đầu \( y_0 \):</label>
                <input type="number" id="y0" step="any" value="1">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="x1">\( x_1 \):</label>
                <input type="number" id="x1" step="any" value="0.02">
            </div>
            <div class="input-group">
                <label for="x2">\( x_2 \):</label>
                <input type="number" id="x2" step="any" value="0.03">
            </div>
            <div class="input-group">
                <label for="h">Kích thước bước \( h \):</label>
                <input type="number" id="h" step="any" value="0.01">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="iterations">Số lần lặp:</label>
                <input type="number" id="iterations" min="1" value="3">
            </div>
            <div class="input-group">
                <label for="decimalPlaces">Dấu chấm động:</label>
                <input type="number" id="decimalPlaces" min="0" max="34" value="6">
            </div>
        </div>
    </div>

    <button onclick="calculateEuler()">Calculate</button>

    <div id="result" class="result-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="result-title">Kết quả của phương pháp Euler cải tiến</h2>
            <button id="toggleView" class="toggle-btn" onclick="toggleViewMode()">Thu gọn</button>
        </div>
        <div style="background-color: #24ff7f; color: white; padding: 8px 15px; border-radius: 4px; margin-top: 10px;">
            Calculation successful ✅
        </div>

        <div id="equation-display" class="math-formula"></div>

        <div class="step">
            <h3>Initial Values</h3>
            <div id="initial-values" class="math-formula"></div>
        </div>

        <div class="step">
            <h3>Calculate \( y_1 \)</h3>
            <div id="y1-calculation" class="math-formula"></div>
            <div id="y1-iterations"></div>
        </div>

        <div class="step">
            <h3>Calculate \( y_2 \)</h3>
            <div id="y2-calculation" class="math-formula"></div>
            <div id="y2-iterations"></div>
        </div>

        <div class="final-result">
            <h3>Final Results</h3>
            <div id="final-results-table"></div>
        </div>
    </div>

    <script>
        function goToHomeWithTransition() {
            document.body.classList.add('page-fade-out');
            setTimeout(function () {
                window.location.href = '../index.html';
            }, 300);
        }

        // Original rounding function
        function roundTo(value, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        }
        // Original formatNumber function
        function formatNumber(num) {
            const dcd = parseInt(document.getElementById('decimalPlaces').value);
            decimals = dcd // Note: global variable 'decimals', original code had this
            if (num === null || num === undefined) return "NaN";
            const rounded = roundTo(num, decimals);
            let str = rounded.toString();

            // Remove trailing zeros and possible decimal point
            if (str.indexOf('.') !== -1) {
                str = str.replace(/\.?0+$/, '');
            }

            // Original logic had this check at the end
            if (str.endsWith('.')) str = str.slice(0, -1);

            return str === '' ? '0' : str;
        }


        // Original formatExpression function
        function formatExpression(expr) {
            // Xử lý hàm exp() và e^ thành e^{...}
            expr = expr.replace(/exp\(([^)]+)\)/g, 'e^{$1}')
                .replace(/e\^\(([^)]+)\)/g, 'e^{$1}'); // Original handled only e^(...)

            // Các thay thế khác
            return expr
                .replace(/log/g, '\\ln')
                .replace(/\^/g, '^') // Original replaced ^ with ^
                .replace(/sqrt\(([^)]+)\)/g, '\\sqrt{$1}')
                .replace(/\*/g, '\\cdot ')
                .replace(/\\cdot/g, ''); // Original removed cdot again
            // Original did not handle fractions explicitly
        }

        // Original calcFunction
        function calcFunction(f, xVal, yVal) {
            try {
                // Thay thế exp(x) thành e^x trước khi tính toán - This logic seems redundant if math.js handles 'e'
                // let processedExpr = f.replace(/exp\(([^)]+)\)/g, 'e^($1)');
                // Replace x and y with their values using regex to avoid replacing parts of words
                const expr = f.replace(/\bx\b/g, `(${xVal})`).replace(/\by\b/g, `(${yVal})`);
                // Use math.evaluate, provide 'e' constant
                return math.evaluate(expr, { e: Math.E });
            } catch (e) {
                throw new Error(`Error evaluating function f(${xVal}, ${yVal}): ${e.message}`);
            }
        }

        // Original replaceVars - Note: this was quite complex and might have issues
        function replaceVars(str, varNames, variables) {
            varNames.forEach(varName => {
                // Xử lý biến đứng riêng hoặc sau toán tử
                str = str.replace(new RegExp(`(^|[^a-zA-Z0-9_])${varName}([^a-zA-Z0-9_]|$)`, 'g'),
                    `$1${varName}_${variables[varName]}$2`);

                // Xử lý biến đứng sau số (như 2x, 3y)
                str = str.replace(new RegExp(`(\\d)${varName}([^a-zA-Z0-9_]|$)`, 'g'),
                    `$1${varName}_${variables[varName]}$2`);
            });
            return str;
        }

        // Original format_k - Note: this relied on replaceVars
        function format_k(expr, variables = { x: '0', y: '0' }) {
            // Tạo danh sách biến cần thay thế (theo thứ tự dài trước ngắn)
            const varNames = Object.keys(variables).sort((a, b) => b.length - a.length);

            // Bước 1: Xử lý các hàm đặc biệt (exp, e^) trước - Original logic
            expr = expr.replace(/exp\(([^)]+)\)/g, (match, inner) => {
                return `exp(${replaceVars(inner, varNames, variables)})`;
            });

            expr = expr.replace(/e\^([^+\-*/( )]+)/g, (match, inner) => { // Original regex for e^
                return `e^{${replaceVars(inner, varNames, variables)}}`;
            });

            // Bước 2: Xử lý toàn bộ biểu thức - Original logic
            expr = replaceVars(expr, varNames, variables);

            // Call formatExpression at the end
            return formatExpression(expr);
        }


        // Original function to create horizontal table
        function createHorizontalTable(data, prefix) {
            // Get decimal places inside this function scope if needed, or pass it
            const decimalPlaces = parseInt(document.getElementById('decimalPlaces').value);
            // Format numbers using the original formatNumber
            const formatFn = (val) => formatNumber(val); // Use original formatNumber

            return `
                 <div class="horizontal-scroll-container">
                     <table class="horizontal-table">
                         <thead>
                             <tr>
                                 <th class="fixed-column"> \\(k\\)</th>
                                 ${data.map(item => `<th> \\(${prefix}^{(${item.iteration})}\\)</th>`).join('')}
                             </tr>
                         </thead>
                         <tbody>
                             <tr>
                                 <td class="fixed-column"> \\(${prefix}^{(k+1)}\\)</td>
                                  ${data.map(item => `<td> \\(${formatFn(item.value)}\\)</td>`).join('')}
                             </tr>
                         </tbody>
                     </table>
                 </div>`;
        }

        let isDetailedView = true;
        let currentResults = {};

        // Original calculateEuler function with only animation/scroll added
        function calculateEuler() {
            const resultSection = document.getElementById('result');
            // ---- Added for animation ----
            resultSection.classList.remove('show');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // ---------------------------
                    try {
                        // Get input values (original way)
                        const y_diff = document.getElementById('y_diff').value;
                        const x0 = parseFloat(document.getElementById('x0').value);
                        const y0 = parseFloat(document.getElementById('y0').value);
                        const x1 = parseFloat(document.getElementById('x1').value);
                        const x2 = parseFloat(document.getElementById('x2').value);
                        const h = parseFloat(document.getElementById('h').value);
                        const iterations = parseInt(document.getElementById('iterations').value);
                        const decimalPlaces = parseInt(document.getElementById('decimalPlaces').value); // Get decimals

                        // Original validation (simple NaN check)
                        if (isNaN(x0) || isNaN(y0) || isNaN(x1) || isNaN(x2) || isNaN(h) || isNaN(iterations) || isNaN(decimalPlaces)) {
                            throw new Error("Please enter valid numerical values for all inputs");
                        }
                        if (iterations < 1) { // Original check
                            throw new Error("Number of iterations must be at least 1");
                        }

                        // ---- Removed: document.getElementById('result').style.display = 'block'; ----

                        // Calculate y1 (Original logic)
                        const f_x0_y0 = calcFunction(y_diff, x0, y0); // Calc f(x0,y0) once
                        const s0_y1 = y0 + h * f_x0_y0; // Use the calculated value

                        let y1_values = [];
                        let current_y1 = s0_y1;
                        for (let i = 0; i < iterations; i++) {
                            // Calculate f(x1, current_y1) inside the loop
                            const f_x1_current_y1 = calcFunction(y_diff, x1, current_y1);
                            current_y1 = y0 + h / 2 * (f_x0_y0 + f_x1_current_y1); // Use f(x0,y0) again
                            y1_values.push({ iteration: i + 1, value: current_y1 });
                        }
                        const y1_final = y1_values.length > 0 ? y1_values[y1_values.length - 1].value : s0_y1;

                        // Calculate y2 (Original logic)
                        const f_x1_y1_final = calcFunction(y_diff, x1, y1_final); // Calc f(x1, y1_final) once
                        const s0_y2 = y1_final + h * f_x1_y1_final; // Use the calculated value

                        let y2_values = [];
                        let current_y2 = s0_y2;
                        for (let i = 0; i < iterations; i++) {
                            // Calculate f(x2, current_y2) inside the loop
                            const f_x2_current_y2 = calcFunction(y_diff, x2, current_y2);
                            current_y2 = y1_final + h / 2 * (f_x1_y1_final + f_x2_current_y2); // Use f(x1, y1_final) again
                            y2_values.push({ iteration: i + 1, value: current_y2 });
                        }
                        const y2_final = y2_values.length > 0 ? y2_values[y2_values.length - 1].value : s0_y2;

                        // Store results (Original structure)
                        currentResults = {
                            data: {
                                y_diff, x0, y0, x1, x2, h, iterations,
                                y1_values, y2_values, y1_final, y2_final, s0_y1, s0_y2
                            },
                            // Pass decimalPlaces to render functions if needed by original formatNumber
                            decimalPlaces: decimalPlaces
                        };

                        // Render detailed view (Original call)
                        isDetailedView = true;
                        renderDetailedView(currentResults.data); // Pass data only

                        // ---- Added for animation ----
                        resultSection.classList.add('show');
                        setTimeout(() => {
                            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                        // ---------------------------

                    } catch (e) {
                        // Display error (Original structure)
                        resultSection.innerHTML = `
                             <div class="error">
                                 <h3>Error</h3>
                                 <p>${e.message}</p>
                                 <p>Please check your inputs and try again.</p>
                             </div>
                         `;
                        // ---- Added for animation ----
                        resultSection.classList.add('show');
                        setTimeout(() => {
                            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                        // ---------------------------
                    }

                    // Render MathJax (Changed to promise-based)
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([resultSection]).catch((err) => console.error('MathJax typesetting error:', err));
                    } else if (typeof MathJax !== 'undefined') {
                        MathJax.typeset(); // Fallback
                    }
                    // ---- Added for animation ----
                });
            });
            // ---------------------------
        }

        // Original renderDetailedView function
        function renderDetailedView(data) {
            const { y_diff, x0, y0, x1, x2, h, iterations, y1_values, y2_values, y1_final, y2_final, s0_y1, s0_y2 } = data;
            // Get decimal places inside or pass it if formatNumber needs it explicitly
            const decimalPlaces = parseInt(document.getElementById('decimalPlaces').value);

            // Use original formatNumber indirectly via createHorizontalTable or directly
            const formatFn = (val) => formatNumber(val); // Assuming formatNumber uses the global 'decimals'

            document.getElementById('result').innerHTML = `

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="result-title">Kết quả của phương pháp Euler cải tiến</h2>
                    <button id="toggleView" class="toggle-btn" onclick="toggleViewMode()">Thu gọn</button>
                </div>
                 <div style="background-color: #24ff7f; color: white; padding: 8px 15px; border-radius: 4px; margin-top: 10px;">
                     Tính toán thành công ✅
                 </div>
                <div id="equation-display" class="math-formula"></div>
                <div class="step">
                    <h3>Các điểm tính toán:</h3>
                    <div id="initial-values" class="math-formula"></div>
                </div>
                <div class="step">
                    <h3>Tính \\(y_1\\)</h3>
                    <div id="y1-calculation" class="math-formula"></div>
                    <div id="y1-iterations"></div>
                </div>
                <div class="step">
                    <h3>Tính \\(y_2\\)</h3>
                    <div id="y2-calculation" class="math-formula"></div>
                    <div id="y2-iterations"></div>
                </div>
                <div class="final-result">
                    <h3>Kết quả cuối cùng</h3>
                    <div id="final-results-table"></div>
                </div>
            `;

            // Fill content using original functions
            document.getElementById('equation-display').innerHTML = `
                <p>Phương trình vi phân:</p>
                <p>\\[ y' = ${formatExpression(y_diff)} \\]</p>
            `;
            document.getElementById('initial-values').innerHTML = `
                 <p>Các điểm tính toán:</p> <p>\\[ y(${formatFn(x0)}) = ${formatFn(y0)}; x_1 = ${formatFn(x1)}; x_2 = ${formatFn(x2)} \\]</p> <p>Kích thước bước: \\[ h = ${formatFn(h)} \\]</p> `;
            document.getElementById('y1-calculation').innerHTML = `
                 <p>Xấp xỉ ban đầu:</p>
                 <p>\\[ y_1^{(0)} = y_0 + h f(x_0, y_0) = y_0 + h(${format_k(y_diff, { x: '0', y: '0' })}) \\]</p> <p>\\[ =${formatFn(y0)} + ${formatFn(h)} \\times ${formatFn(calcFunction(y_diff, x0, y0))} = ${formatFn(s0_y1)} \\]</p> <p>Lặp cải tiến:</p>
                 <p>\\[ y_1^{(k+1)} = y_0 + \\frac{h}{2} \\left[ f(x_0, y_0) + f(x_1, y_1^{(k)}) \\right] \\]</p>
                 <p> \\[ y_1^{(k+1)} = y_0 + \\frac{h}{2} \\left[ (${format_k(y_diff, { x: '0', y: '0' })}) + (${format_k(y_diff, { x: '1', y: '1^{(k)}' })})  \\right]\\] </p> `;
            // Display y1 iterations table using original function
            document.getElementById('y1-iterations').innerHTML = createHorizontalTable(y1_values, 'y_1'); // Pass prefix only

            document.getElementById('y2-calculation').innerHTML = `
                 <p>Xấp xỉ ban đầu:</p>
                 <p> \\[ y_2^{(0)} = y_1 + h f(x_1, y_1) = y_1 + h(${format_k(y_diff, { x: '1', y: '1' })}) \\]</p> <p> \\[ = ${formatFn(y1_final)} + ${formatFn(h)} \\times ${formatFn(calcFunction(y_diff, x1, y1_final))} = ${formatFn(s0_y2)} \\]</p> <p>Lặp cải tiến:</p>
                 <p>\\[ y_2^{(k+1)} = y_1 + \\frac{h}{2} \\left[ f(x_1, y_1) + f(x_2, y_2^{(k)}) \\right] \\]</p>
                 <p> \\[ y_2^{(k+1)} = y_1 + \\frac{h}{2} \\left[ (${format_k(y_diff, { x: '1', y: '1' })}) + (${format_k(y_diff, { x: '2', y: '2^{(k)}' })})  \\right]\\] </p> `;
            // Display y2 iterations table using original function
            document.getElementById('y2-iterations').innerHTML = createHorizontalTable(y2_values, 'y_2'); // Pass prefix only

            // Display final result (original structure)
            let finalTableHTML = `
                 <div class="success-box"> 
                    <div class="success-box2"> <p style="color: #0afc6f; font-size: 20px;"> \\(\\quad\\) Kết quả xấp xỉ : </p> 
                        <div style="font-size: 1.3em; text-align: center;">
                              \\[y(${formatFn(x1)}) \\approx ${formatFn(y1_final)}; \\quad y(${formatFn(x2)}) \\approx ${formatFn(y2_final)} \\] 
                        </div>
                    </div>
                 </div>`;
            document.getElementById('final-results-table').innerHTML = finalTableHTML;
        }


        // Original renderCompactView function
        function renderCompactView(data) {
            const { y_diff, x0, y0, x1, x2, h, y1_values, y2_values, y1_final, y2_final, s0_y1, s0_y2 } = data;
            // Get decimal places if needed by formatNumber called indirectly
            const decimalPlaces = parseInt(document.getElementById('decimalPlaces').value);
            const formatFn = (val) => formatNumber(val); // Use original formatNumber

            document.getElementById('result').innerHTML = `

                 <div style="display: flex; justify-content: space-between; align-items: center;">
                     <h2 class="result-title">Kết quả của phương pháp Euler cải tiến</h2>
                     <button id="toggleView" class="toggle-btn" onclick="toggleViewMode()">Chi tiết</button>
                 </div>
                 <div style="background-color: #24ff7f; color: white; padding: 8px 15px; border-radius: 4px; margin-top: 10px;">
                     Tính toán thành công ✅
                 </div>
                 <div id="main-result-content"></div>
             `;

            const mainContent = document.getElementById('main-result-content');
            mainContent.innerHTML = `
                 <div class="math-formula">
                     <p>Phương trình vi phân:</p>
                     <p>\\[ y' = ${formatExpression(y_diff)}; x_0 = ${formatFn(x0)}; y_0 = ${formatFn(y0)}; x_1 = ${formatFn(x1)}; x_2 = ${formatFn(x2)} \\]</p> </div>

                 <div class="step math-formula">
                     <p>Tính y₁ tại x = ${formatFn(x1)}</p> <p>\\[
                          \\begin{cases}
                              y_1^{(0)} =y_0 + h(${format_k(y_diff, { x: '0', y: '0' })}) = ${formatFn(s0_y1)} \\\\[2ex]
                              y_1^{(k+1)} = y_0 + \\frac{h}{2} \\left[ (${format_k(y_diff, { x: '0', y: '0' })}) + (${format_k(y_diff, { x: '1', y: '1^{(k)}' })})  \\right]
                          \\end{cases}
                      \\]</p>
                     ${createHorizontalTable(y1_values, 'y₁')} </div>

                 <div class="step math-formula">
                     <p>Tính y₂ tại x = ${formatFn(x2)}</p> <p>\\[
                          \\begin{cases}
                               y_2^{(0)} = y_1 + h(${format_k(y_diff, { x: '1', y: '1' })}) = ${formatFn(s0_y2)} \\\\[2ex]
                               y_2^{(k+1)} = y_1 + \\frac{h}{2} \\left[ (${format_k(y_diff, { x: '1', y: '1' })}) + (${format_k(y_diff, { x: '2', y: '2^{(k)}' })})  \\right]
                          \\end{cases}
                      \\]</p>

                     ${createHorizontalTable(y2_values, 'y₂')} </div>

                 <div class="final-result math-formula"> <h3>Kết quả cuối cùng</h3>
                      <p> \\[y(${formatFn(x1)}) \\approx ${formatFn(y1_final)} \\] </p> 
                      <p> \\[y(${formatFn(x2)}) \\approx ${formatFn(y2_final)}\\]</p> </div>
             `;
        }

        // Original toggleViewMode function
        function toggleViewMode() {
            const toggleBtn = document.getElementById('toggleView');
            const resultContainer = document.getElementById('result'); // Ensure result container exists

            if (!resultContainer || !currentResults.data) return;

            isDetailedView = !isDetailedView;

            if (isDetailedView) {
                // Render detailed view using the stored results
                renderDetailedView(currentResults.data);
                // toggleBtn text updated inside renderDetailedView
            } else {
                // Render compact view using the stored results
                renderCompactView(currentResults.data);
                // toggleBtn text updated inside renderCompactView
            }

            // Re-render MathJax for the updated content
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([resultContainer]).catch((err) => console.error('MathJax typesetting error:', err));
            } else if (typeof MathJax !== 'undefined') {
                MathJax.typeset(); // Fallback
            }
        }

    </script>
</body>

</html>
